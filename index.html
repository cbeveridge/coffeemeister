
<!DOCTYPE html>
<html>
	<head>
		<title>Coffee's Ready!</title>
		
		<script src="/socket.io/socket.io.js"><!--x--></script>
		<script type="text/javascript" 
        src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>

		<meta name='viewport' content='width=device-width' />

		<script type="text/javascript">
      
      			var availableStops = [];
				var notificationsOK = false;



				var socket = io();
				socket.on('connect', function(){
					console.log('connected');

					var subscribe = function(stop){
						socket.emit('subscribe', stop);
						$('#main').html('<h1>Waiting...</h1><p>Please leave this window/browser open. If you have enabled ' +
						'notifications from the browser, you can minimise this window and you will be alerted at the time. If ' +'notifications are not enabled, you will need to somehow keep this window visible. Images will ' + 
							'turn red when the time comes</p>');
					}

					

					socket.on('disconnect', function(){
						console.log('disconnected');
					});

					socket.on('arrived', function(notice){
						console.log(notice);
						if ( checkNotifications() ) {
							var notification = new Notification(notice.heading, 
								{body: notice.body, icon:notice.icon});
						}
						$( "#body" ).removeClass( "withPicture withoutPicture" ).addClass( "withPicture" );
						var html = "<h1>" + notice.heading + "</h1><p><b><em>" + notice.body + "</em></b>";
						if ( notice.socketAction == 'close' ) {
							html += "<p>This page is now inactive. </p><p>Please close the window.</p>";
							socket.emit('feedback')
							socket.disconnect();
						}
						$('#main').html(html);

					});

					socket.emit('getStops');

					socket.on('availableStops', function(stops){

						availableStops = stops;
						console.log(stops)

						var html = '<h1>Choose Coffee Stop</h1><p>Click on one of the following to subscribe to notification of arrival at this stop.</p><ol>';
						stops.forEach(function(stop){
							html+= '<li><span id="' + stop.name.replace(/ /g,'_') + '">' + stop.name + '</span></li>'
						})
						html += '</ol>';
						$('#main').html(html);

						stops.forEach(function(stop){
							$('#'+stop.name.replace(/ /g,'_') ).click(function(){
								subscribe(stop);
							})
						})

					});

				}); 

				function checkNotifications(){
					var notificationsOK = false;
					if (!("Notification" in window)) {
					    alert("This browser does not support desktop notification");
					  }

					  // Let's check if the user is okay to get some notification
					  else if (Notification.permission === "granted") {
					    // If it's okay let's create a notification
					    notificationsOK = true;
					  }

					  // Otherwise, we need to ask the user for permission
					  else if (Notification.permission !== 'denied') {
					    Notification.requestPermission(function (permission) {
					      // If the user is okay, let's create a notification
					      if (permission === "granted") {
					        notificationsOK = true;
					      }
					    });
					  }

					  return notificationsOK;
				}

				notificationsOK = checkNotifications();



      </script>

      <style type="text/css">

      	body { height: 100%; width: 100%; padding:2em; margin:0; background-repeat: repeat;}
      	body.withPicture { background-image: url("images/Nicattos-logo.gif")  }
      	body.withoutPicture { background-image: url("images/Nicattos-waiting.png")  }
      	#main { padding: 1em; background-color: white; color: black; font-size: 1.5em; opacity: 0.85; width: 20em;}
      	#main li { font-weight: bolder; font-style: italic; font-size: 1em; margin-top:1em;}
      	#main p { font-weight: normal; font-size: 0.85em;}
      </style>

	</head>
	<body id="body" class="withoutPicture">
		<div id="main"></div>		
	</body>
</html>
